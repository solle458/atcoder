## 要件定義書：Mixing on the Palette (AHC048)

### 1. 概要
本問題は、指定された$H$種類の目標色を、$N \times N$のパレットと$K$種類のチューブ絵の具を使い、最大$T$ターンの操作で順番通りに作成する問題です。目的は、使用する絵の具のコストと、作成された色と目標色の誤差を最小化することです。

---
### 2. 機能要件

#### 2.1. 初期設定
1.  **入力読み込み:**
    * パレットサイズ $N$、チューブ絵の具の種類数 $K$、作成目標色数 $H$、最大ターン数 $T$、チューブ絵の具のコスト $D$ を標準入力から読み込む。
    * $K$種類のチューブ絵の具それぞれの色情報 $(C_i^{\mathrm{own}}, M_i^{\mathrm{own}}, Y_i^{\mathrm{own}})$ (各成分は0以上1以下の実数) を標準入力から読み込む。
    * $H$種類の目標色それぞれの色情報 $(C_i^{\mathrm{target}}, M_i^{\mathrm{target}}, Y_i^{\mathrm{target}})$ (各成分は0以上1以下の実数) を標準入力から読み込む。
2.  **パレット初期化:**
    * $N \times N$ パレットの初期の仕切り状態（縦 $N \times (N-1)$ 個、横 $(N-1) \times N$ 個）を決定する。
    * 決定した仕切り状態を後述の「7. 出力形式」に従って標準出力する。
    * パレット上のウェル（連結したマスの集合）の状態を管理する内部データ構造を初期化する（初期状態では絵の具なし）。

#### 2.2. ターン毎の処理 (最大 $T$ ターン)
各ターンにおいて、以下のいずれかの操作を1つ選択し実行、その操作内容を後述の「7. 出力形式」に従って標準出力する。
1.  **操作1: チューブから絵の具を追加**
    * 対象マス $(i,j)$ ($0 \le i,j < N$) とチューブ番号 $k$ ($0 \le k < K$) を選択する。
    * 選択したマスが属するウェルに、チューブ $k$ から1グラムの絵の具を追加する。
    * ウェルの残り容量 $w$ に対し、実際に混合されるのは $\min(w, 1)$ グラム。超過分 $1 - \min(w, 1)$ グラムは廃棄される。
    * ウェル内の既存絵の具と追加された絵の具が混合され、新しい色と量が計算される。
2.  **操作2: 画伯へ絵の具を渡す**
    * 対象マス $(i,j)$ を選択する。
    * 選択したマスが属するウェルから1グラムの絵の具を取り出し、現在の目標色として画伯に渡す。
    * ウェル内の絵の具が $1 - 10^{-6}$ グラム未満の場合は実行不可。
    * 取り出す量は、ウェル内の量が1グラム以上なら正確に1グラム、$1 - 10^{-6} \le v < 1$ の場合は全量。
    * この操作は**合計で正確に $H$ 回**実行されなければならない。
3.  **操作3: 絵の具を廃棄**
    * 対象マス $(i,j)$ を選択する。
    * 選択したマスが属するウェルから1グラムの絵の具を廃棄する。ウェル内の絵の具が1グラム未満の場合は全量を廃棄する。
4.  **操作4: 仕切りを操作**
    * 隣接する2マス $(i_1, j_1)$ と $(i_2, j_2)$ を選択し、その間の仕切りを上げ下げする。
    * **合併時:** 2つのウェルが1つに結合され、それぞれの絵の具が混合されて1つの色になる。合計量も合算される。
    * **分割時:** 1つのウェルが2つに分割され、元の絵の具は分割後の各ウェルの容量に比例して分配される（色は変わらない）。分割前の絵の具量を $v$、分割後の $s$ 側と $t$ 側の容量をそれぞれ $v_s, v_t$ とすると、$s$ 側には $v \times \frac{v_s}{v_s + v_t}$、$t$ 側には $v \times \frac{v_t}{v_s + v_t}$ の絵の具が残る。

---
### 3. 計算ロジック
1.  **色表現:** 色は $(C, M, Y)$ の3成分で表現され、各成分は $0.0 \sim 1.0$ の実数値（double型で管理）。
2.  **絵の具の混合:**
    * 色 $p_1 = (C_1, M_1, Y_1)$ の絵の具 $v_1$ グラムと、色 $p_2 = (C_2, M_2, Y_2)$ の絵の具 $v_2$ グラムを混ぜると、新しい色は $\frac{v_1 \cdot p_1 + v_2 \cdot p_2}{v_1 + v_2}$ となり、量は $v_1 + v_2$ グラムとなる。ベクトル演算として各成分ごとに計算する。
3.  **ウェルの容量:** $k$個のマスで構成されるウェルの最大容量は $k$ グラム。
4.  **計算誤差:**
    * 操作2の実行可否判定: ウェルの絵の具量 $v$ が $v < 1 - 10^{-6}$ の場合は不可。
    * 操作2の取り出し量: $v \ge 1$ の場合は1グラム、$1 - 10^{-6} \le v < 1$ の場合は全量 $v$ グラム。

---
### 4. 状態管理
1.  **パレットの状態:**
    * 各マスの所属ウェルID。
    * 縦横の仕切りの状態 (開/閉)。
2.  **ウェルの状態:**
    * 構成マスの数（容量）。
    * 現在の絵の具の色 $(C, M, Y)$。
    * 現在の絵の具の量 (double)。
3.  **進行状況:**
    * 現在のターン数。
    * 操作1（チューブからの追加）の実行総回数 $V$。
    * 操作2（画伯へ渡す）の実行回数。
    * 画伯へ渡した色の記録（$H$回分）。
    * 現在の目標色のインデックス。

---
### 5. 制約遵守
* 最大ターン数 $T$ を超えない。
* 操作2は正確に $H$ 回実行する。
* 後述の「7. 出力形式」を遵守する。

---
### 6. 評価基準
1.  **絶対スコア:** $1 + D \cdot (V - H) + \mathrm{round}(10^4 \times E)$
    * $V$: 操作1の総実行回数。
    * $E = \sum_{i=0}^{H-1} \sqrt{(C_i^{\mathrm{target}} - C_i^{\mathrm{made}})^2 + (M_i^{\mathrm{target}} - M_i^{\mathrm{made}})^2 + (Y_i^{\mathrm{target}} - Y_i^{\mathrm{made}})^2}$
    * この絶対スコアが小さいほど良い。
2.  **相対スコア:** 各テストケースの自身の絶対スコアと、全参加者中の最小絶対スコアの比率で計算される。この合計が最終スコアとなる。

---
### 7. 出力形式

#### 7.1. 初期仕切り状態の出力
プログラムの最初に、以下の形式でパレットの初期仕切り状態を出力する。
1.  **縦の仕切り:** $N$ 行にわたり、各行に $N-1$ 個の整数をスペース区切りで出力する。
    $v_{i,j}$  ($0 \le i < N, 0 \le j < N-1$): マス $(i,j)$ とマス $(i,j+1)$ の間の仕切り状態。
    * `0`: 仕切りは下がっている (連結)
    * `1`: 仕切りは上がっている (非連結)
    ```
    v_0,0 v_0,1 ... v_0,N-2
    v_1,0 v_1,1 ... v_1,N-2
    ...
    v_N-1,0 v_N-1,1 ... v_N-1,N-2
    ```
2.  **横の仕切り:** $N-1$ 行にわたり、各行に $N$ 個の整数をスペース区切りで出力する。
    $h_{i,j}$ ($0 \le i < N-1, 0 \le j < N$): マス $(i,j)$ とマス $(i+1,j)$ の間の仕切り状態。
    * `0`: 仕切りは下がっている (連結)
    * `1`: 仕切りは上がっている (非連結)
    ```
    h_0,0 h_0,1 ... h_0,N-1
    h_1,0 h_1,1 ... h_1,N-1
    ...
    h_N-2,0 h_N-2,1 ... h_N-2,N-1
    ```

#### 7.2. 各ターンの操作出力
初期仕切り状態の出力後、最大 $T$ 行にわたり、各ターンで行う操作を以下のいずれかの形式で出力する。
1.  **操作1 (チューブから絵の具を追加):**
    `1 i j k`
    * `i`: マスの行座標 ($0 \le i < N$)
    * `j`: マスの列座標 ($0 \le j < N$)
    * `k`: チューブ番号 ($0 \le k < K$)
2.  **操作2 (画伯へ絵の具を渡す):**
    `2 i j`
    * `i`: マスの行座標 ($0 \le i < N$)
    * `j`: マスの列座標 ($0 \le j < N$)
3.  **操作3 (絵の具を廃棄):**
    `3 i j`
    * `i`: マスの行座標 ($0 \le i < N$)
    * `j`: マスの列座標 ($0 \le j < N$)
4.  **操作4 (仕切りを操作):**
    `4 i1 j1 i2 j2`
    * `i1 j1`: 1つ目のマスの座標 ($0 \le i_1, j_1 < N$)
    * `i2 j2`: 2つ目のマスの座標（$(i_1, j_1)$ と隣接していること）

---
### 8. 非機能要件
1.  **実行時間:** 3秒以内。
2.  **メモリ:** 1024 MiB以内。
3.  プログラムは標準入力から読み込み、標準出力へ書き出す。
4.  標準出力へのフラッシュを適宜行うこと（特にインタラクティブな問題ではないが、出力が多い場合に備える）。

---
### 9. アルゴリズム・戦略に関する考慮事項
* **初期仕切り配置:** ウェルをどのように初期配置するかが、後の操作効率に影響する可能性がある。
* **目標色の生成戦略:**
    * どのチューブ絵の具を、どのウェルで、どのように混合して目標色に近い色を作るか。
    * 既存のウェルの絵の具を再利用するか、新たにチューブから出すか。
    * コスト $D$ の大きさを考慮し、チューブからの絵の具使用回数 $V$ を抑える戦略と、色誤差 $E$ を小さくする戦略のバランスを取る。
* **ウェル管理:**
    * ウェルのマージと分割を効果的に利用し、絵の具の移動や混合を効率化する。
    * 不要になった絵の具や、目標色作成の邪魔になる絵の具の廃棄戦略。
* **探索的アプローチ:**
    * 各ターンで最適な操作を選択するための評価関数と探索アルゴリズム（例：貪欲法、ビームサーチ、焼きなまし法など）の検討。
    * 長期的な視点での計画（例：数手先の目標色を見据えたパレット利用計画）。
* **計算精度:** double型での演算に伴う誤差の蓄積に注意し、比較や判定は問題文の指示に従う。
